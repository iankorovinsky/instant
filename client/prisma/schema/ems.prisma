// EMS Models

enum execution_status {
  PENDING
  SIMULATING
  PARTIALLY_FILLED
  FILLED
  SETTLED
  CANCELLED
}

model Execution {
  executionId        String           @id @default(uuid())
  orderId            String
  accountId          String
  instrumentId       String
  side               order_side
  totalQuantity      Decimal          @db.Decimal(18, 2)
  filledQuantity     Decimal          @db.Decimal(18, 2)
  avgFillPrice       Decimal?         @db.Decimal(10, 4)
  status             execution_status @default(PENDING)
  asOfDate           DateTime
  executionStartTime DateTime?
  executionEndTime   DateTime?
  settlementDate     DateTime?
  settledDate        DateTime?
  slippageTotal      Decimal?         @db.Decimal(12, 6)
  slippageBreakdown  Json?
  deterministicInputs Json?
  explanation        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  order      Order      @relation(fields: [orderId], references: [orderId], onDelete: Restrict)
  account    Account    @relation(fields: [accountId], references: [accountId], onDelete: Restrict)
  instrument Instrument @relation(fields: [instrumentId], references: [cusip], onDelete: Restrict)
  fills      Fill[]

  @@map("executions")
  @@index([orderId])
  @@index([accountId])
  @@index([instrumentId])
  @@index([status])
  @@index([asOfDate])
}

model Fill {
  fillId      String   @id @default(uuid())
  executionId String
  clipIndex   Int
  quantity    Decimal  @db.Decimal(18, 2)
  price       Decimal  @db.Decimal(10, 4)
  timestamp   DateTime
  slippage    Decimal  @db.Decimal(12, 6)

  createdAt DateTime @default(now())

  // Relations
  execution Execution @relation(fields: [executionId], references: [executionId], onDelete: Cascade)

  @@map("fills")
  @@index([executionId])
  @@index([timestamp])
}
